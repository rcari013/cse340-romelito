<div class="appointment-layout">

  <!-- LEFT SIDE — Vehicle -->
  <div class="vehicle-box">
    <h2><%= vehicle.inv_make %> <%= vehicle.inv_model %> (<%= vehicle.inv_year %>)</h2>

    <img src="<%= vehicle.inv_image %>" 
         alt="<%= vehicle.inv_make %> <%= vehicle.inv_model %>">

    <ul>
      <li><strong>Price:</strong> $<%= new Intl.NumberFormat("en-US").format(vehicle.inv_price) %></li>
      <li><strong>Mileage:</strong> <%= new Intl.NumberFormat("en-US").format(vehicle.inv_miles) %> miles</li>
      <li><strong>Color:</strong> <%= vehicle.inv_color %></li>
    </ul>

    <p class="desc"><%= vehicle.inv_description %></p>
  </div>


  <!-- RIGHT SIDE — Booking Form -->
  <section class="booking-form-container">
    <h1>Schedule a Test Drive</h1>

    <%- messages() %>

    <form method="POST" class="appointment-form-vertical">

      <div class="form-group">
        <label for="date">Preferred Date</label>
        <input 
          type="date" 
          id="date" 
          name="date" 
          required
          min="<%= new Date().toISOString().split('T')[0] %>"
        >
      </div>

      <div class="form-group">
        <label for="time">Preferred Time</label>
        <select id="time" name="time" required>
          <option value="">Select a Time</option>
          <option value="08:00 AM">08:00 AM</option>
          <option value="09:00 AM">09:00 AM</option>
          <option value="10:00 AM">10:00 AM</option>
          <option value="11:00 AM">11:00 AM</option>
          <option value="01:00 PM">01:00 PM</option>
          <option value="02:00 PM">02:00 PM</option>
          <option value="03:00 PM">03:00 PM</option>
          <option value="04:00 PM">04:00 PM</option>
        </select>

      </div>

      <div class="form-group">
        <label for="message">Message (Optional)</label>
        <textarea id="message" name="message" rows="4"></textarea>
      </div>

      <button type="submit" class="test-drive-btn">
        Confirm Appointment
      </button>

    </form>
  </section>

</div>


<script>
document.addEventListener("input", function (event) {
  if (event.target.tagName.toLowerCase() !== "textarea") return;
  const ta = event.target;
  ta.style.height = "auto";
  ta.style.height = ta.scrollHeight + "px";
});
</script>

<script>
// Auto-scroll to form after 2 seconds ONLY on mobile screens
document.addEventListener("DOMContentLoaded", function () {
  const isMobile = window.innerWidth <= 768;

  if (isMobile) {
    setTimeout(() => {
      const formSection = document.querySelector(".booking-form-container");
      if (formSection) {
        formSection.scrollIntoView({ behavior: "smooth" });
      }
    }, 2000);
  }
});
</script>

<script>
// Disable weekends in date input
document.addEventListener("DOMContentLoaded", function () {
  const dateInput = document.getElementById("date");

  dateInput.addEventListener("change", function () {
    const selected = new Date(this.value);
    const day = selected.getDay(); // 0=Sun, 6=Sat

    if (day === 0 || day === 6) {
      alert("Weekends are not available for test drives. Please choose a weekday.");
      this.value = "";    // Clear invalid date
    }
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const dateInput = document.getElementById("date");
  const timeSelect = document.getElementById("time");
  const invId = "<%= vehicle.inv_id %>";

  dateInput.addEventListener("change", async function () {
    const selectedDate = this.value;
    if (!selectedDate) return;

    // Fetch booked times from backend
    const response = await fetch(`/appointment/booked-times/${invId}?date=${selectedDate}`);
    const booked = await response.json(); // Example: ["08:00:00", "16:00:00"]

    // Enable all options first
    [...timeSelect.options].forEach(opt => {
      opt.disabled = false;
      opt.textContent = opt.textContent.replace(" (Booked)", ""); 
    });

    // Convert DB "16:00:00" → "04:00 PM"
    const formatTime = (t) => {
      const [h, m] = t.split(":");
      let hour = parseInt(h); 
      const suffix = hour >= 12 ? "PM" : "AM";
      if (hour > 12) hour -= 12;
      if (hour === 0) hour = 12;
      return `${hour.toString().padStart(2, "0")}:${m} ${suffix}`;
    };

    // Disable booked ones
    booked.forEach(dbTime => {
      const conv = formatTime(dbTime);

      [...timeSelect.options].forEach(opt => {
        if (opt.value === conv) {
          opt.disabled = true;
          opt.textContent = conv + " (Booked)";
        }
      });
    });
  });
});
</script>
